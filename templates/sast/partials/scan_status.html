<div id="scan-status-container"
     {% if scan.status == 'PENDING' or scan.status == 'SCANNING' or scan.status == 'CLONING' %}
     hx-get="{% url 'sast_scan_status' scan.id %}"
     hx-trigger="every 2s"
     hx-swap="outerHTML"
     {% endif %}
     x-data="{ filter: 'ALL' }">

    <!-- Status Banner -->
    <div style="margin-bottom: 20px; padding: 20px; background-color: #161b22; border: 1px solid #30363d; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h4 style="margin: 0; font-size: 1.1em;">
                Status: 
                <span style="
                    {% if scan.status == 'COMPLETED' %}color: #3fb950;
                    {% elif scan.status == 'FAILED' %}color: #f85149;
                    {% elif scan.status == 'CANCELLED' %}color: #8b949e;
                    {% else %}color: #d29922;{% endif %}
                ">
                    {{ scan.get_status_display }}
                </span>
            </h4>
            <p style="margin: 5px 0 0 0; color: #8b949e; font-size: 0.9em;">
                Started {{ scan.created_at|timesince }} ago
                {% if scan.completed_at %} ‚Ä¢ Completed in {{ scan.completed_at|timeuntil:scan.created_at }}{% endif %}
            </p>
        </div>
        
        {% if scan.status == 'PENDING' or scan.status == 'SCANNING' or scan.status == 'CLONING' %}
        <div style="display: flex; align-items: center; color: #d29922;">
            <span class="spinner-sm" style="margin-right: 10px;"></span>
            <span>Processing...</span>
        </div>
        {% endif %}
    </div>

    <!-- Findings Section -->
    {% if scan.findings.exists %}
    <div class="findings-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #c9d1d9;">Vulnerabilities Found ({{ scan.findings.count }})</h3>
            
            <!-- Filter Buttons -->
            <div style="display: flex; gap: 5px;">
                <button @click="filter = 'ALL'" :class="{ 'active': filter === 'ALL' }" class="filter-btn">All</button>
                <button @click="filter = 'CRITICAL'" :class="{ 'active': filter === 'CRITICAL' }" class="filter-btn critical">Critical</button>
                <button @click="filter = 'HIGH'" :class="{ 'active': filter === 'HIGH' }" class="filter-btn high">High</button>
                <button @click="filter = 'MEDIUM'" :class="{ 'active': filter === 'MEDIUM' }" class="filter-btn medium">Medium</button>
                <button @click="filter = 'LOW'" :class="{ 'active': filter === 'LOW' }" class="filter-btn low">Low</button>
            </div>
        </div>
        
        {% for finding in scan.findings.all %}
        <div class="finding-card" 
             x-show="filter === 'ALL' || filter === '{{ finding.severity }}'"
             style="background-color: #161b22; border: 1px solid #30363d; border-radius: 6px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            
            <!-- Card Header -->
            <div class="finding-header" style="padding: 15px; background-color: #21262d; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="
                        padding: 4px 10px; border-radius: 20px; font-size: 0.85em; font-weight: bold; text-transform: uppercase;
                        {% if finding.severity == 'CRITICAL' %}background-color: #f85149; color: white;
                        {% elif finding.severity == 'HIGH' %}background-color: #d29922; color: white;
                        {% elif finding.severity == 'MEDIUM' %}background-color: #db6d28; color: white;
                        {% else %}background-color: #58a6ff; color: white;{% endif %}
                    ">{{ finding.severity }}</span>
                    <span style="font-weight: bold; font-size: 1.1em; color: #c9d1d9;">{{ finding.title }}</span>
                </div>
                <div style="text-align: right;">
                    <div style="color: #8b949e; font-family: monospace; font-size: 0.9em;">
                        <i style="color: #58a6ff;">üìÑ</i> {{ finding.file_path }} : <span style="color: #f85149; font-weight: bold;">Line {{ finding.line_number }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Card Body -->
            <div class="finding-body" style="padding: 20px;">
                <p style="margin-top: 0; color: #c9d1d9; line-height: 1.5;">{{ finding.description }}</p>
                
                <!-- Vulnerable Code Snippet -->
                {% if finding.code_snippet %}
                <div style="margin: 15px 0;">
                    <div style="color: #f85149; font-size: 0.85em; font-weight: bold; margin-bottom: 5px;">‚ùå VULNERABLE CODE:</div>
                    <div style="background-color: #0d1117; padding: 15px; border-radius: 6px; border: 1px solid #f85149; overflow-x: auto;">
                        <code style="font-family: 'Courier New', monospace; color: #c9d1d9; white-space: pre-wrap;">{{ finding.code_snippet }}</code>
                    </div>
                </div>
                {% endif %}

                <!-- AI Analysis -->
                {% if finding.ai_explanation %}
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #30363d;">
                    <strong style="color: #58a6ff; display: flex; align-items: center; gap: 5px;">
                        <span>ü§ñ</span> AI Analysis
                    </strong>
                    <p style="margin-top: 10px; color: #8b949e; line-height: 1.6;">{{ finding.ai_explanation }}</p>
                </div>
                {% endif %}

                <!-- Suggested Fix -->
                {% if finding.fix %}
                <div style="margin-top: 20px; padding: 15px; background-color: rgba(63, 185, 80, 0.05); border: 1px solid rgba(63, 185, 80, 0.3); border-radius: 6px;">
                    <strong style="color: #3fb950; display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                        <span>‚úÖ</span> Suggested Fix
                    </strong>
                    <p style="margin: 0 0 15px 0; font-size: 0.95em; color: #c9d1d9;">{{ finding.fix.explanation }}</p>
                    
                    <div style="background-color: #0d1117; border-radius: 6px; border: 1px solid #30363d; overflow: hidden;">
                        <div style="padding: 8px 15px; background-color: #21262d; border-bottom: 1px solid #30363d; font-size: 0.85em; color: #8b949e;">
                            Proposed Change
                        </div>
                        <pre style="margin: 0; padding: 15px; overflow-x: auto; color: #3fb950;"><code style="font-family: 'Courier New', monospace;">{{ finding.fix.proposed_code }}</code></pre>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif scan.status == 'COMPLETED' %}
    <div style="padding: 60px; text-align: center; background-color: #161b22; border: 1px solid #30363d; border-radius: 6px;">
        <div style="font-size: 3em; margin-bottom: 20px;">‚úÖ</div>
        <h3 style="color: #c9d1d9; margin-bottom: 10px;">No Vulnerabilities Found</h3>
        <p style="color: #8b949e;">Great job! Your code appears to be secure based on our analysis.</p>
    </div>
    {% elif scan.status == 'CANCELLED' %}
    <div style="padding: 60px; text-align: center; background-color: #161b22; border: 1px solid #30363d; border-radius: 6px;">
        <div style="font-size: 3em; margin-bottom: 20px;">üõë</div>
        <h3 style="color: #c9d1d9; margin-bottom: 10px;">Scan Cancelled</h3>
        <p style="color: #8b949e;">This scan was stopped by the user.</p>
    </div>
    {% elif scan.status == 'FAILED' %}
    <div style="padding: 60px; text-align: center; background-color: #161b22; border: 1px solid #30363d; border-radius: 6px;">
        <div style="font-size: 3em; margin-bottom: 20px;">‚ö†Ô∏è</div>
        <h3 style="color: #c9d1d9; margin-bottom: 10px;">Scan Failed</h3>
        <p style="color: #8b949e;">Something went wrong during the scan. Please try again.</p>
    </div>
    {% endif %}

    <style>
        .filter-btn {
            background-color: transparent;
            border: 1px solid #30363d;
            color: #8b949e;
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            background-color: #21262d;
            color: #c9d1d9;
        }
        .filter-btn.active {
            background-color: #58a6ff;
            color: white;
            border-color: #58a6ff;
        }
        .filter-btn.critical.active { background-color: #f85149; border-color: #f85149; }
        .filter-btn.high.active { background-color: #d29922; border-color: #d29922; }
        .filter-btn.medium.active { background-color: #db6d28; border-color: #db6d28; }
        .filter-btn.low.active { background-color: #58a6ff; border-color: #58a6ff; }
    </style>
</div>

<style>
    .filter-btn {
        background-color: #21262d;
        border: 1px solid #30363d;
        color: #c9d1d9;
        padding: 4px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.2s;
    }
    .filter-btn:hover { background-color: #30363d; }
    .filter-btn.active { background-color: #58a6ff; color: white; border-color: #58a6ff; }
    
    .filter-btn.critical.active { background-color: #f85149; border-color: #f85149; }
    .filter-btn.high.active { background-color: #d29922; border-color: #d29922; }
    .filter-btn.medium.active { background-color: #db6d28; border-color: #db6d28; }
    .filter-btn.low.active { background-color: #58a6ff; border-color: #58a6ff; }
</style>

<div id="scan-controls" hx-swap-oob="true" style="display: flex; gap: 10px;">
    {% if scan.status == 'PENDING' or scan.status == 'SCANNING' or scan.status == 'CLONING' %}
        <form method="post" action="{% url 'sast_cancel_scan' scan.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" style="background-color: #da3633; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Stop Scan
            </button>
        </form>
    {% else %}
        <form method="post" action="{% url 'start_scan' scan.project.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary" style="background-color: #238636; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Run New Scan
            </button>
        </form>
    {% endif %}
</div>
