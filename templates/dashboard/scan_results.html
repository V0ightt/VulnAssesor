{% extends 'base.html' %}

{% block title %}Scan Results - {{ scan.website.name }} - VulnAssesor{% endblock %}

{% block content %}
<div class="results-container">
    <div class="results-header">
        <div>
            <h2>Scan Results</h2>
            <p class="subtitle">Scan #{{ scan.id }} - {{ scan.website.name }}</p>
        </div>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Back to Dashboard
        </a>
    </div>

    <div class="scan-summary">
        <div class="summary-card">
            <div class="summary-icon">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
            </div>
            <div>
                <div class="summary-value">{{ scan.website.url }}</div>
                <div class="summary-label">Target</div>
            </div>
        </div>

        <div class="summary-card">
            <div class="summary-icon severity-critical">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                </svg>
            </div>
            <div>
                <div class="summary-value">{{ results.count }}</div>
                <div class="summary-label">Total Findings</div>
            </div>
        </div>

        <div class="summary-card">
            <div class="summary-icon">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
            </div>
            <div>
                <div class="summary-value">{{ scan.created_at|date:"M d, Y H:i" }}</div>
                <div class="summary-label">Started</div>
            </div>
        </div>

        <div class="summary-card">
            <div class="summary-icon status-completed">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                </svg>
            </div>
            <div>
                <div class="summary-value">{{ scan.completed_at|date:"H:i:s" }}</div>
                <div class="summary-label">Completed</div>
            </div>
        </div>
    </div>

    {% if results %}
    <div class="severity-breakdown">
        {% if results_by_severity.critical %}
        <div class="severity-stat critical">
            <span class="count">{{ results_by_severity.critical.count }}</span>
            <span class="label">Critical</span>
        </div>
        {% endif %}
        {% if results_by_severity.high %}
        <div class="severity-stat high">
            <span class="count">{{ results_by_severity.high.count }}</span>
            <span class="label">High</span>
        </div>
        {% endif %}
        {% if results_by_severity.medium %}
        <div class="severity-stat medium">
            <span class="count">{{ results_by_severity.medium.count }}</span>
            <span class="label">Medium</span>
        </div>
        {% endif %}
        {% if results_by_severity.low %}
        <div class="severity-stat low">
            <span class="count">{{ results_by_severity.low.count }}</span>
            <span class="label">Low</span>
        </div>
        {% endif %}
        {% if results_by_severity.info %}
        <div class="severity-stat info">
            <span class="count">{{ results_by_severity.info.count }}</span>
            <span class="label">Info</span>
        </div>
        {% endif %}
    </div>

    <div class="results-list" x-data="{ expandedResult: null }">
        {% for result in results %}
        <div class="result-card severity-{{ result.severity }}" :class="{ 'expanded': expandedResult === {{ result.id }} }">
            <div class="result-header" @click="expandedResult = expandedResult === {{ result.id }} ? null : {{ result.id }}">
                <div class="result-title-section">
                    <span class="severity-badge severity-{{ result.severity }}">
                        {{ result.get_severity_display }}
                    </span>
                    <h3>{{ result.vulnerability_name }}</h3>
                </div>
                <button class="expand-btn" type="button">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"
                         :style="expandedResult === {{ result.id }} ? 'transform: rotate(180deg)' : ''">
                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>

            <div class="result-body" x-show="expandedResult === {{ result.id }}" x-collapse>
                <div class="result-info">
                    <div class="info-item">
                        <strong>Template:</strong>
                        <span>{{ result.template_name }}</span>
                    </div>
                    <div class="info-item">
                        <strong>Target URL:</strong>
                        <a href="{{ result.target_url }}" target="_blank" rel="noopener noreferrer">
                            {{ result.target_url }}
                        </a>
                    </div>
                    <div class="info-item">
                        <strong>Detected:</strong>
                        <span>{{ result.created_at|date:"M d, Y H:i:s" }}</span>
                    </div>
                </div>

                <div class="raw-data">
                    <div class="raw-data-header">
                        <strong>Raw Finding Data</strong>
                        <button type="button"
                                @click="navigator.clipboard.writeText(JSON.stringify({{ result.raw_finding|safe }}, null, 2))"
                                class="btn-icon"
                                title="Copy to clipboard">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                        </button>
                    </div>
                    <pre class="json-data">{{ result.raw_finding|safe }}</pre>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon status-completed">
            <svg width="80" height="80" fill="currentColor" viewBox="0 0 16 16">
                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
            </svg>
        </div>
        <h3>No Vulnerabilities Found</h3>
        <p>Great news! The scan didn't detect any vulnerabilities matching your templates.</p>
    </div>
    {% endif %}
</div>

<style>
.results-container {
    max-width: 1200px;
    margin: 0 auto;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.scan-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.summary-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 1.5rem;
}

.summary-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: rgba(88, 166, 255, 0.1);
    border-radius: 6px;
    color: #58a6ff;
}

.summary-icon.severity-critical {
    background: rgba(248, 81, 73, 0.1);
    color: #f85149;
}

.summary-icon.status-completed {
    background: rgba(63, 185, 80, 0.1);
    color: #3fb950;
}

.summary-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: #c9d1d9;
    word-break: break-all;
}

.summary-label {
    font-size: 0.875rem;
    color: #8b949e;
    margin-top: 0.25rem;
}

.severity-breakdown {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    margin-bottom: 2rem;
}

.severity-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    border-radius: 6px;
    min-width: 80px;
}

.severity-stat.critical {
    background: rgba(248, 81, 73, 0.1);
    border: 1px solid #f85149;
}

.severity-stat.high {
    background: rgba(255, 159, 10, 0.1);
    border: 1px solid #ff9f0a;
}

.severity-stat.medium {
    background: rgba(217, 153, 34, 0.1);
    border: 1px solid #d29922;
}

.severity-stat.low {
    background: rgba(88, 166, 255, 0.1);
    border: 1px solid #58a6ff;
}

.severity-stat.info {
    background: rgba(139, 148, 158, 0.1);
    border: 1px solid #8b949e;
}

.severity-stat .count {
    font-size: 1.75rem;
    font-weight: 700;
    color: #c9d1d9;
}

.severity-stat .label {
    font-size: 0.875rem;
    color: #8b949e;
    margin-top: 0.25rem;
}

.results-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.result-card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    overflow: hidden;
    transition: all 0.2s ease;
}

.result-card.severity-critical {
    border-left: 4px solid #f85149;
}

.result-card.severity-high {
    border-left: 4px solid #ff9f0a;
}

.result-card.severity-medium {
    border-left: 4px solid #d29922;
}

.result-card.severity-low {
    border-left: 4px solid #58a6ff;
}

.result-card.severity-info {
    border-left: 4px solid #8b949e;
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    cursor: pointer;
    user-select: none;
}

.result-header:hover {
    background: #0d1117;
}

.result-title-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.result-title-section h3 {
    margin: 0;
    font-size: 1.125rem;
    color: #c9d1d9;
}

.severity-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.severity-badge.severity-critical {
    background: rgba(248, 81, 73, 0.2);
    color: #f85149;
}

.severity-badge.severity-high {
    background: rgba(255, 159, 10, 0.2);
    color: #ff9f0a;
}

.severity-badge.severity-medium {
    background: rgba(217, 153, 34, 0.2);
    color: #d29922;
}

.severity-badge.severity-low {
    background: rgba(88, 166, 255, 0.2);
    color: #58a6ff;
}

.severity-badge.severity-info {
    background: rgba(139, 148, 158, 0.2);
    color: #8b949e;
}

.expand-btn {
    background: none;
    border: none;
    color: #8b949e;
    cursor: pointer;
    padding: 0.5rem;
    transition: all 0.2s ease;
}

.expand-btn:hover {
    color: #c9d1d9;
}

.expand-btn svg {
    transition: transform 0.2s ease;
}

.result-body {
    padding: 0 1.5rem 1.5rem;
    border-top: 1px solid #30363d;
}

.result-info {
    display: grid;
    gap: 1rem;
    margin: 1.5rem 0;
}

.info-item {
    display: flex;
    gap: 0.5rem;
}

.info-item strong {
    color: #8b949e;
    min-width: 120px;
}

.info-item span,
.info-item a {
    color: #c9d1d9;
}

.raw-data {
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    overflow: hidden;
}

.raw-data-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #161b22;
    border-bottom: 1px solid #30363d;
}

.raw-data-header strong {
    color: #c9d1d9;
    font-size: 0.875rem;
}

.json-data {
    padding: 1rem;
    margin: 0;
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    color: #c9d1d9;
}
</style>
{% endblock %}

