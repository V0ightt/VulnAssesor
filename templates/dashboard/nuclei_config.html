{% extends 'base.html' %}

{% block title %}Nuclei Configuration - VulnAssesor{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-header">
        <h2>Nuclei CLI Configuration</h2>
        <div style="display: flex; gap: 0.5rem;">
            <form method="post" action="{% url 'nuclei_update_templates' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary" onclick="return confirm('Update Nuclei default templates? This may take a few minutes.');">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Update Templates
                </button>
            </form>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Back to Dashboard
            </a>
        </div>
    </div>

    <div class="config-info">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
        <p>Configure how Nuclei runs vulnerability scans. Changes apply to all future scans.</p>
    </div>

    <form method="post" class="config-form" x-data="configForm()">
        {% csrf_token %}

        <div class="config-section">
            <h3>
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                    <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                </svg>
                Performance Settings
            </h3>
            <p class="section-description">Control scan speed and resource usage</p>

            <div class="config-grid">
                <div class="form-group">
                    <label for="timeout">Timeout (seconds)</label>
                    <input type="number" id="timeout" name="timeout"
                           value="{{ config.timeout|default:600 }}"
                           min="60" max="3600"
                           class="form-input"
                           x-model.number="timeout"
                           @input="updatePreview()">
                    <p class="form-help">Maximum scan duration: <span x-text="formatTime(timeout)"></span></p>
                </div>

                <div class="form-group">
                    <label for="rate_limit">Rate Limit (req/sec)</label>
                    <input type="number" id="rate_limit" name="rate_limit"
                           value="{{ config.rate_limit|default:150 }}"
                           min="1" max="1000"
                           class="form-input"
                           x-model.number="rateLimit"
                           @input="updatePreview()">
                    <p class="form-help">Requests per second (1-1000)</p>
                </div>

                <div class="form-group">
                    <label for="concurrency">Concurrency</label>
                    <input type="number" id="concurrency" name="concurrency"
                           value="{{ config.concurrency|default:25 }}"
                           min="1" max="100"
                           class="form-input"
                           x-model.number="concurrency"
                           @input="updatePreview()">
                    <p class="form-help">Parallel template execution (1-100)</p>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                    <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                    <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                </svg>
                Output Settings
            </h3>
            <p class="section-description">Configure output format and verbosity</p>

            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="silent_mode" {% if config.silent_mode %}checked{% endif %} x-model="silentMode" @change="updatePreview()">
                    <span>Silent Mode</span>
                    <p class="checkbox-help">Hide banner and progress information</p>
                </label>

                <label class="checkbox-label">
                    <input type="checkbox" name="no_color" {% if config.no_color %}checked{% endif %} x-model="noColor" @change="updatePreview()">
                    <span>No Color</span>
                    <p class="checkbox-help">Disable colored output</p>
                </label>

                <label class="checkbox-label">
                    <input type="checkbox" name="jsonl_output" {% if config.jsonl_output %}checked{% endif %} x-model="jsonlOutput" @change="updatePreview()">
                    <span>JSONL Output</span>
                    <p class="checkbox-help">⚠️ Required for result parsing - keep enabled</p>
                </label>
            </div>
        </div>

        <div class="config-section">
            <h3>
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                    <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855.173-.324.33-.682.468-1.068H8.5zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49a13.65 13.65 0 0 1-.312 2.5zm2.802-3.5a6.959 6.959 0 0 0-.656-2.5H12.18c.174.782.282 1.623.312 2.5h2.49zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7.024 7.024 0 0 0-3.072-2.472c.218.284.418.598.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"/>
                </svg>
                Network Settings
            </h3>
            <p class="section-description">Configure network behavior</p>

            <div class="config-grid">
                <div class="form-group">
                    <label for="retries">Retries</label>
                    <input type="number" id="retries" name="retries"
                           value="{{ config.retries|default:1 }}"
                           min="0" max="10"
                           class="form-input"
                           x-model.number="retries"
                           @input="updatePreview()">
                    <p class="form-help">Retry failed requests (0-10)</p>
                </div>

                <div class="form-group">
                    <label for="max_host_errors">Max Host Errors</label>
                    <input type="number" id="max_host_errors" name="max_host_errors"
                           value="{{ config.max_host_errors|default:30 }}"
                           min="1" max="100"
                           class="form-input"
                           x-model.number="maxHostErrors"
                           @input="updatePreview()">
                    <p class="form-help">Stop scan after this many errors (1-100)</p>
                </div>

                <div class="form-group">
                    <label class="checkbox-label" style="margin-top: 0;">
                        <input type="checkbox" name="follow_redirects" {% if config.follow_redirects %}checked{% endif %} x-model="followRedirects" @change="updatePreview()">
                        <span>Follow Redirects</span>
                        <p class="checkbox-help">Follow HTTP 3xx redirects</p>
                    </label>
                </div>
            </div>
        </div>

        <div class="config-section">
            <h3>
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/>
                </svg>
                Advanced Settings
            </h3>
            <p class="section-description">Additional Nuclei CLI arguments</p>

            <div class="form-group">
                <label for="custom_args">Custom Arguments</label>
                <textarea id="custom_args" name="custom_args"
                          rows="3"
                          placeholder="e.g., -proxy http://proxy:8080 -header 'X-Custom: value'"
                          class="form-textarea"
                          x-model="customArgs"
                          @input="updatePreview()">{{ config.custom_args }}</textarea>
                <p class="form-help">⚠️ Use with caution. Space-separated arguments. Quoted strings supported.</p>
            </div>
        </div>

        <div class="config-section command-preview">
            <h3>
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                    <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
                </svg>
                Command Preview (Live)
            </h3>
            <div class="command-box">
                <code x-text="commandPreview"></code>
            </div>
            <p class="form-help">This is how Nuclei will be executed (with example target)</p>
        </div>

        <div class="form-actions">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                </svg>
                Save Configuration
            </button>
        </div>
    </form>
</div>

<script>
function configForm() {
    return {
        // Initialize all fields with current config values
        timeout: {{ config.timeout }},
        rateLimit: {{ config.rate_limit }},
        concurrency: {{ config.concurrency }},
        silentMode: {{ config.silent_mode|lower }},
        noColor: {{ config.no_color|lower }},
        jsonlOutput: {{ config.jsonl_output|lower }},
        retries: {{ config.retries }},
        maxHostErrors: {{ config.max_host_errors }},
        followRedirects: {{ config.follow_redirects|lower }},
        customArgs: '{{ config.custom_args|escapejs }}',
        commandPreview: '{{ example_command }}',

        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (mins > 0) {
                return `${mins}m ${secs}s`;
            }
            return `${secs}s`;
        },

        updatePreview() {
            // Build command preview dynamically
            let cmd = ['nuclei'];

            // Target
            cmd.push('-target', 'https://example.com');

            // Templates (example)
            cmd.push('-t', '/tmp/templates');

            // Output format
            if (this.jsonlOutput) {
                cmd.push('-jsonl');
            }

            // Silent mode
            if (this.silentMode) {
                cmd.push('-silent');
            }

            // No color
            if (this.noColor) {
                cmd.push('-no-color');
            }

            // Rate limit
            cmd.push('-rate-limit', this.rateLimit);

            // Concurrency
            cmd.push('-c', this.concurrency);

            // Retries
            if (this.retries > 0) {
                cmd.push('-retries', this.retries);
            }

            // Follow redirects
            if (!this.followRedirects) {
                cmd.push('-no-follow-redirects');
            }

            // Max host errors
            cmd.push('-max-host-error', this.maxHostErrors);

            // Timeout
            cmd.push('-timeout', this.timeout);

            // Custom arguments
            if (this.customArgs && this.customArgs.trim()) {
                cmd.push(this.customArgs.trim());
            }

            this.commandPreview = cmd.join(' ');
        },

        init() {
            // Initialize preview on load
            this.updatePreview();
        }
    }
}
</script>

<style>
.config-info {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: rgba(88, 166, 255, 0.1);
    border: 1px solid #58a6ff;
    border-radius: 6px;
    margin-bottom: 2rem;
    color: #58a6ff;
}

.config-form {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 2rem;
}

.config-section {
    margin-bottom: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #30363d;
}

.config-section:last-of-type {
    border-bottom: none;
}

.config-section h3 {
    display: flex;
    align-items: center;
    margin: 0 0 0.5rem 0;
    color: #c9d1d9;
    font-size: 1.25rem;
}

.config-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1.5rem;
}

.checkbox-label {
    display: flex;
    flex-direction: column;
    padding: 1rem;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.checkbox-label:hover {
    border-color: #58a6ff;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-right: 0.75rem;
    cursor: pointer;
}

.checkbox-label span {
    font-weight: 600;
    color: #c9d1d9;
    margin-bottom: 0.25rem;
}

.checkbox-help {
    margin: 0.25rem 0 0 0;
    font-size: 0.875rem;
    color: #8b949e;
}

.command-preview {
    background: rgba(88, 166, 255, 0.05);
    padding: 1.5rem;
    border-radius: 6px;
    border: 1px solid #30363d;
}

.command-box {
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 1rem;
    margin-top: 1rem;
    overflow-x: auto;
}

.command-box code {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    color: #58a6ff;
    word-break: break-all;
    white-space: pre-wrap;
}
</style>
{% endblock %}

